
\documentclass{article}

\usepackage{graphviz}
\usepackage{url}
\usepackage{hyperref}
\usepackage{fullpage}
\usepackage{parskip}
\usepackage{fancyvrb}
\usepackage{amsmath}
\usepackage[section]{placeins}
\usepackage{tikz-timing}

\usepackage{listings}
\lstset{numbers=left,
		basicstyle=\footnotesize,
		captionpos=b,
		xleftmargin=0.3in}

\usepackage[backend=biber,autocite=footnote,
	            bibstyle=authortitle,citestyle=verbose-inote]{biblatex}
\addbibresource{refs.bib}
\setlength\bibitemsep{1em}

\usepackage[xindy,toc,nonumberlist]{glossaries}
\makeglossaries
\renewcommand*{\glspostdescription}{}

\providecommand{\e}[1]{\ensuremath{\times 10^{#1}}}

\VerbatimFootnotes

\raggedright

\begin{document}

% {{{ glossary entries

\newglossaryentry{SPI}
{
	name={SPI},
	description={Serial peripheral interface}.
}

\newglossaryentry{MOSI}
{
	name={MOSI},
	description={(SPI) master out slave in}.
}

\newglossaryentry{MISO}
{
	name={MOSI},
	description={(SPI) master in slave out}.
}

\newglossaryentry{GPIO}
{
	name={GPIO},
	description={General purpose input/output}.
}

\newglossaryentry{FIFO}
{
	name={FIFO},
	description={First in first out}.
}

\newglossaryentry{RFID}
{
	name={RFID},
	description={Radio frequency identification}.
}


% }}}

% {{{ title page
\vspace*{1.0in}

\centerline{\LARGE \textbf{SprinklerPI}}
\vspace{0.3in}
\centerline{\LARGE Product Design}

\vfill

\begin{center}
\begin{tabular}{c}
Jeremiah Mahler \\
EECE 490B, CSU Chico \\
May 6, 2014
\end{tabular}
\end{center}

\vspace{2in}

\thispagestyle{empty}

\pagebreak
% }}}

\nocite{rasberrypi}
\thispagestyle{empty}
\tableofcontents

% {{{ Architectural Design
\clearpage
\section{Architectural Design}

SprinklerPI is a web based sprinkler control system.
At the highest level it provides a web interface
which allows watering schedules to be created and modified.
To serve this web interface requires a web server.
In this case a web server running on Linux is used.

Each control/driver module can drive eight sprinkler valves.
And they accepts commands sent over SPI.
They can also be daisy chained together to drive more valves.
Since the RasberryPI can communicate over SPI it also
acts as the master of the SPI bus and sends these commands.

Between the web server and the SPI device both queuing and scheduling
must be performed.
A web server is not suited for these tasks because it is request driven.
To bridge this gap a set of daemons are provided.
Each one handles a specific tasks such as scheduling or queuing.

The communication channel between the web server and the daemons is the
file system.
A specific set of files at specific locations stores the entire state
of the system.
And these files are all in human readable format so they
can be accessed using standard command line tools.

And to power all of these devices requires a power supply capable
of providing both 24 volts AC and 3.3 volts DC.

Figure \ref{fig:spioview} shows an overview of the system.

\begin{figure}[h!]
\begin{center}
\includegraphics[scale=0.40]{dia/sprinklerpi_overview}
\end{center}
\caption{Overview of main components inside the SprinklerPI system.}
\label{fig:spioview}
\end{figure}

\begin{samepage}
When this system is installed on a private network or behind a firewall
it cannot be accessed from the Internet.  With the addition of a
client/server water daemon, that acts as a proxy, this system can still be
used as shown in Figure \ref{fig:spioviewnet}.
\end{samepage}

\begin{figure}[h!]
\begin{center}
\includegraphics[scale=0.40]{dia/sprinklerpi_overview-net}
\end{center}
\caption{SprinklerPI system configured for access behind a firewall.}
\label{fig:spioviewnet}
\end{figure}

% }}}

% {{{ Hardware Design
\clearpage
\section{Hardware Design}
\label{sec:hardware}

There are three main hardware components in this system.
First is the power supply.
It takes 24 volts AC and outputs both 3.3 volts DC and 24 volts AC.
The sprinkler valves require 24 volts AC.
The Linux computer and digital logic require 3.3 volts DC.
Second is the Linux computer which is a RasberryPI model B.
And third is the Control Driver which contains all the
circuitry needed to accept commands using SPI from the RasberryPI
and to drive up to eight individual sprinkler valves.
Additional control/driver modules can be added in a SPI daisy chain
configuration to drive additional valves.
Each individual control/driver supports eight valves.
Figure \ref{fig:hwoview} gives an overview of the hardware in the system.

\begin{figure}[h!]
\begin{center}
\includegraphics[scale=0.9]{xcircuit/hardware_overview}
\end{center}
\caption{Overview of hardware in system.
Only one control/driver is shown, 
additional control/drivers can be added up to a maximum of three.
Expansion is limited by the power supply.}
\label{fig:hwoview}
\end{figure}

% {{{ State Flow Diagrams
\subsection{State Flow Diagrams}

The primary module of interest with regard to state flow is
the Control Driver (Figure \ref{fig:hwoview}).
It controls the sprinkler valves based on commands it receives
from the Linux computer (RasberryPI) over SPI.

The Control Driver is always either driving one of the eight valves
or has all of the valves off.
The only time this changes is when a new command is sent.

During power on all the valves must remain in the off state.
If this were not required, and the system entered some random
state during power on, a valve could be inadvertently turned on.
And since there is no watchdog mechanism this valve would remain
on until the next command was received.
Figure \ref{fig:hwstate} shows the state machine of the
Control Driver circuitry in hardware.

\begin{figure}[h!]
\centering
\includegraphics[scale=0.48]{dia/hardware_state}
\caption{State diagram of hardware control circuitry.
During power on it is important that the valves remain off.
In the idle state it waits for a command to turn on a valve or
turn off all valves.}\label{fig:hwstate}
\end{figure}

The hardware state is determined by the control circuitry
described in Section \ref{sec:control}.

% }}}

% {{{ Schematics
\clearpage
\FloatBarrier
\subsection{Schematics}

% {{{ Control
\FloatBarrier
\subsubsection{Control}
\label{sec:control}

Before a sprinkler valve can be driven some control logic is necessary
between the RasberryPI and the driver (Section \ref{sec:driver}).
Most residential sprinkler systems are capable of driving eight circuits.
And only one of these circuits is active at any one time
\footnote{If multiple circuits were active this could lower the
water pressure resulting in inconsistent watering amounts.}.
This controller is similar except it also supports expansion by groups
of eight circuits.

This design uses SPI and a minimum of 8-bits is sent per message.
Each control group requires 4-bits.  So for one to two control groups
8-bits are required.  For three to four control groups 16-bits are required,
and so on.  Figure \ref{fig:spi} shows the message format.

Each 4-bit control message contains a single enable bit.
This design was chosen to simplify the clear of the decoder
(Figure \ref{fig:control}).

{
\renewcommand*\arraystretch{1.5}
\begin{figure}[hbp]

\centering

\begin{tabular}{l r l r l r }
7 & 4 & 3 & 1 & \multicolumn{2}{c}{0} \\
\hline
\multicolumn{2}{|c|}{\hspace*{6mm} unused \hspace*{6mm}} &
\multicolumn{2}{|c|}{\hspace*{4mm} valve (group \#1) \hspace*{4mm}} &
\multicolumn{2}{|c|}{\hspace*{1mm} en\_n \hspace*{1mm}} \\
\hline
\end{tabular} \\
(a)

\begin{tabular}{l r l r l r l r }
7 & 5 & \multicolumn{2}{c}{4} & 3 & 1 & \multicolumn{2}{c}{0} \\
\hline
%\multicolumn{2}{|c|}{\hspace*{6mm} unused \hspace*{6mm}} &
\multicolumn{2}{|c|}{\hspace*{4mm} valve (group \#2) \hspace*{4mm}} &
\multicolumn{2}{|c|}{\hspace*{1mm} en\_n \hspace*{1mm}} &
\multicolumn{2}{|c|}{\hspace*{4mm} valve (group \#1) \hspace*{4mm}} &
\multicolumn{2}{|c|}{\hspace*{1mm} en\_n \hspace*{1mm}} \\
\hline
\end{tabular} \\
(b)

\caption{SPI message format for one group (a) and two groups (b).
Each group represents eight valves so (b) would support 16 valves.}
\label{fig:spi}
\end{figure}
}

Translating the message received over SPI to turn on
a sprinkler valve requires a small amount of discrete logic.
A shift register is needed to take the bits as inputs.
A decoder is needed to convert shifted in number to a single
bit output.
In this case a 74HC238 3-8 decoder is used since it provides non-inverting
outputs.
An output high will turn on a valve.
Figure \ref{fig:control} shows the control schematic.

\begin{figure}[hbp]
\includegraphics[scale=0.85]{xcircuit/control}
\caption{Sprinkler valve control logic.
Sprinkler valve number is input using SPI from the RasberryPI in
to the shift register.  The number is decoded and inverted to produce
a single high signal for one valve.
All outputs are disabled when OA is clear.}\label{fig:control}
\end{figure}

On power up it is important that the valves remain off.
However the shift register chip (74HC194) does not guarantee
the output state during power up.
To resolve this issue a simple RC circuit is used to to hold the
chip in the clear state for several seconds after power
on (Figure \ref{fig:control}).

% }}}

% {{{ Expansion
\clearpage
\subsubsection{Expansion}
\label{sec:expansion}

The RasberryPI uses SPI to communicate with the
control logic which which drives the sprinkler valve.
Each group can control up to eight valves with one valve
being on at a time.
A daisy chain arrangement can be constructed to allow SPI
to communicate with more than one group as shown in
Figure \ref{fig:expansion_spi}.

\begin{figure}[hbp]
\centering
\includegraphics[angle=0,scale=0.80]{xcircuit/expansion_spi}
\caption{Daisy chain SPI configuration to for multiple control groups.
}\label{fig:expansion_spi}
\end{figure}

With the current power supply design it is limited to three
control groups as shown in Figure \ref{fig:expansion_current}.
Each group can control eight valves with one being on at a time.
This makes a total of 24 valves where three can be on at once.

\begin{figure}[hbp]
\centering
\includegraphics[angle=0,scale=0.80]{xcircuit/expansion_current}
\caption{With a power supply capable of 1 amp at 24 volts AC and
600 mA at 3.3 volts DC a maximum of three control groups and one
Rasberry PI can be driven.}\label{fig:expansion_current}
\end{figure}

% }}}

% {{{ Driver
\FloatBarrier
\subsubsection{Driver}
\label{sec:driver}

The control circuit (Section \ref{sec:control}) provides a digital
output signal in the range of 0 to 3.3 volts DC.
This signal is inadequate for driving the sprinkler valve which
requires 24 volts AC.
The driver circuit discussed here is used to apply 24 volts AC
signal when triggered by a 3.3 volts DC signal.

\begin{figure}[hbp]
\centering
\includegraphics[scale=0.7]{xcircuit/driver_mult}
\caption{Sprinkler valve driver circuits.
Not all branches are shown since they are identical.
LEDs are used to indicate when the valve is on/off.
It is assumed that only one valve will be on at a time.}\label{fig:driver}
\end{figure}

To turn the sprinkler valves on requires 24 VAC at approximately 270 mA.
If it is assumed that during steady state both the solenoid
and the triac have negligible resistance (Figure \ref{fig:driver}),
a 10 $\Omega$ resistor can be used to limit the current to 270 mA.
At 1 watt the resistor supports the worst case amperage with a margin
over 10\%.

\begin{align*}
	P &= I^2 R \\
	  &= (270\e{-3})^2 \cdot 10 \\
	  &= 0.729 \quad \text{[W]}
\end{align*}

The control signal to the triac (Q401E4) is very sensitive.
The tinyest current will cause it to conduct.
If it is driven by a 0-5V signal it will conduct not only
with a 5V signal but also with 0V signal.
To overcome this issue a diode was used to ensure no current
flows when it is reverse biased.
The FET (2N7000) is used to switch the triac while it also
serves to limit the control current of a 0-3.3 volt signal
to less than 0.5 mA.
This places the control current well within the limits
of CMOS logic as required by the control chips (Section \ref{sec:control}).

% }}}

% {{{ Power Supply
\subsubsection{Power Supply}
\label{sec:power}

The power supply must provide two different voltages: 24 volts AC and
3.3 volts DC.
The sprinkler valves require 24 volts AC at 270 mA.
The Linux computer and other digital logic require 3.3 volts DC with a
maximum draw of 600 mA
\footnote{The current draw of the RasberryPI was determined
experimentally to be approximately 500 mA.}.
These voltages must be created from a 24 volt AC input.
The 24 volts AC is converted from 110 volts AC using a transformer.
Plug mounted 110 to 24 volts AC transformers are commonly available
as most sprinkler controllers use these.

A switching voltage regulator, the MC34063A, was chosen for
the 3.3 volt supply.
It has a greater efficiency than a linear regulator such as
the LM7805.

The circuit which achieves all of these design requirements is
shown in Figure \ref{fig:power}.

\begin{figure}[hbp]
\centering
\includegraphics[angle=90,scale=0.70]{xcircuit/power_supply}
\caption{Power supply circuit. A 24 volt AC and 3.3 volt DC output are
provided.  The 3.3 volt DC is provided by the MC340363A switching
regulator.}\label{fig:power}
\end{figure}

% }}}

% }}}

% {{{ Timing Diagrams
\FloatBarrier
\subsection{Timing Diagrams}

Figure \ref{fig:timing} is a diagram of a message being sent
using SPI from the Linux computer to the control module.
Refer to Section \ref{sec:control} for a description of
the meaning of these messages.

\begin{figure}[h!]
\begin{center}
\begin{tikztimingtable}
	[xscale=2.0, yscale=2.0]
	CE	 & {1H} 1{C} {12L} 1{C} {1H} \\
	SCLK & {1H} 14{C} {1H} \\
	MOSI & 10L 1{C} 1{H} 1{C} 3L \\
	MISO & 16L \\
\end{tikztimingtable}
\end{center}
\caption{Timing diagram of a message sent using SPI from
the RasberryPI to a control module.
A value from MOSI is latched on the rising edge of SCLK.
In this case the value 2 is transferred.}
\label{fig:timing}
\end{figure}
% }}}

% {{{ Theory of Operation
\FloatBarrier
\subsection{Theory of Operation}

% describe external interface

The operation of the hardware as a whole provides the ability to
turn a valve on or to turn them all off.
One valve can be on at a time for a single Control Driver module.
Commands are written over SPI from the Linux computer (RasberryPI).

The user interface, described in Section \ref{sec:swdesign}, will
establish a friendly user interface on top of this simple hardware
interface.

% }}}

% }}}

% {{{ Software Design
\FloatBarrier
\section{Software Design}
\label{sec:swdesign}

The software creates a user interface for controlling
and scheduling the sprinkler valves.
Figure \ref{fig:swoview} gives an overview of the system.

\begin{figure}[htbp!]
\begin{center}
\includegraphics[scale=0.45]{dia/software_overview}
\end{center}
\caption{Overview of software in the sprinkler control system.
The web server (www) communicates with the queue daemon
using a set of files.
The queue daemon monitors the queue and controls the valves accordingly.
The timer daemon adds jobs to the queue according to the timer schedule.}
\label{fig:swoview}
\end{figure}

\FloatBarrier
\subsection{File System}

Interprocess communication between the queue daemon, the web server
and the timer daemon is accomplished using files.
The following is a listing of the files that are present.

\begin{verbatim}
sprinklerpi/
  queue
  valve
  clear
  log
  timer/
    valve1
     ...
    valve8
\end{verbatim}

\begin{itemize}
    \item \verb+queue+ - Queue of jobs to execute.
    \item \verb+valve+ - Current valve number that is running.
        Zero if none are running.
    \item \verb+clear+ - When true the queue daemon clears the queue.
        It is reset to false after queue is cleared.
    \item \verb+log+ - Log of operations queue-daemon has performed.
    \item \verb+timer/valve*+ - Schedule of when each valve should run.
\end{itemize}

\FloatBarrier
\subsection{Queue Daemon}

The queue daemon monitors the queue file and executes the command.
An example command might be ``run valve 3 for 5 minutes''.
Figure \ref{fig:queue-daemon} gives a flow chart of its operation.

\begin{figure}[htbp!]
\begin{center}
\includegraphics[scale=0.45]{dia/queue-daemon}
\end{center}
\caption{Flow chart of the queue daemon operation.}
\label{fig:queue-daemon}
\end{figure}

% TODO - abort operation?

\clearpage
\FloatBarrier
\subsection{Timer Daemon}

The timer daemon monitors the valve schedule and adds jobs
to the queue when they are ready to be run.
Figure \ref{fig:timer-daemon} gives a flowchart of its operation.

\begin{figure}[htbp!]
\begin{center}
\includegraphics[scale=0.45]{dia/timer-daemon}
\end{center}
\caption{Flow chart of the timer daemon operation.}
\label{fig:timer-daemon}
\end{figure}

% }}}

\pagebreak
\glsaddall
\printglossaries

% References
\clearpage
\printbibliography[heading=bibintoc]

\end{document}
